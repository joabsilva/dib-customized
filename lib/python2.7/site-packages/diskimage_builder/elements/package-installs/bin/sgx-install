#!/bin/bash

if [ ${DIB_DEBUG_TRACE:-1} -gt 0 ]; then
    set -x
fi
set -eu
set -o pipefail

# Set working dir to /var/sgx-driver

# The below will execute only if the sgx-driver is not already present
mkdir -p /var/sgx-driver
cd /var/sgx-driver
git clone https://github.com/intel/linux-sgx-driver
cd /var/sgx-driver/linux-sgx-driver

# Checkout to sgx driver 2.1
git checkout sgx_driver_2.1

# Install linux headers
apt update
apt install -y linux-headers-$(ls /lib/modules | grep generic) build-essential

# Execute steps to install the driver
make -C /lib/modules/$(ls /lib/modules | grep generic)/build SUBDIRS=/var/sgx-driver/linux-sgx-driver CFLAGS_MODULE="-DDEBUG -g -O0" ARCH="x86" modules 
mkdir -p "/lib/modules/$(ls /lib/modules | grep generic)/kernel/drivers/intel/sgx"
cp isgx.ko "/lib/modules/$(ls /lib/modules | grep generic)/kernel/drivers/intel/sgx"
sh -c "cat /etc/modules | grep -Fxq isgx || echo isgx >> /etc/modules"

# Cleanup
rm -rf /var/sgx-driver/linux-sgx-driver

